<?xml version="1.0"?>
<!--  
 Magento Varnish Module
 @author     	Hugues Alary <hugues.alary@gmail.com>
 @copyright  	2012
 @license		GNU General Public License, version 3 (GPL-3.0)
 -->
<layout version="0.1.0">
	
	<default>
        <!-- The cart sidebar is cached on a per-client basis-->
		<reference name="cart_sidebar">
			<action method="setEsi">
            	<params>
            		<cache_type>per-client</cache_type>
            	</params>
            </action>
		</reference>

        <!-- TopLinks could be cached globaly, but in a "out of the box" magento, one of the links contains the number
            of cart items. As this information is different for each client, we need to cache it on a per-client basis.
        -->
        <reference name="top.links">
            <action method="setEsi">
                <params>
                    <cache_type>per-client</cache_type>
                </params>
            </action>
        </reference>

        <!-- Global messages are cached on a per-client basis -->
		<reference name="global_messages">
			<action method="setEsi">
            	<params>
            		<cache_type>per-client</cache_type>
            	</params>
            </action>
		</reference>
		<reference name="messages">
			<action method="setEsi">
            	<params>
            		<cache_type>per-client</cache_type>
            	</params>
            </action>
		</reference>
	</default>

<!-- Checkout -->

    <!-- We cache the checkout cart page on a per-client basis -->
	<checkout_cart_index>
		<reference name="checkout.cart">
			<action method="setEsi">
            	<params>
            		<cache_type>per-client</cache_type>
            	</params>
            </action>
		</reference>
	</checkout_cart_index>

    <!-- We never cache anything in the checkout funnel -->
	<checkout_onepage_index>
		<varnish_do_not_cache></varnish_do_not_cache>
	</checkout_onepage_index>
	
    <checkout_onepage_progress>
        <varnish_do_not_cache></varnish_do_not_cache>
    </checkout_onepage_progress>

    <checkout_onepage_paymentmethod>
        <varnish_do_not_cache></varnish_do_not_cache>
    </checkout_onepage_paymentmethod>

    <checkout_onepage_shippingmethod>
        <varnish_do_not_cache></varnish_do_not_cache>
    </checkout_onepage_shippingmethod>

    <checkout_onepage_additional>
        <varnish_do_not_cache></varnish_do_not_cache>
    </checkout_onepage_additional>

    <checkout_onepage_review>
        <varnish_do_not_cache></varnish_do_not_cache>
    </checkout_onepage_review>

    <checkout_onepage_success>
        <varnish_do_not_cache></varnish_do_not_cache>
    </checkout_onepage_success>

    <checkout_onepage_failure>
        <varnish_do_not_cache></varnish_do_not_cache>
    </checkout_onepage_failure>
    
 <!-- End Checkout -->
	
</layout>
